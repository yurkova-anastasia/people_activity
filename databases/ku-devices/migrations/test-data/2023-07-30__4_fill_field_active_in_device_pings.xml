<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.17.xsd">

    <changeSet id="1" author="anastasia.yurkova2003@gmail.com" context = "data_migration">
        <sql>
            UPDATE device_pings SET active = FAlSE
        </sql>
    </changeSet>

    <changeSet id="2" author="anastasia.yurkova2003@gmail.com" context = "data_migration">
        <sql>
            UPDATE device_pings AS dp
            SET active = TRUE
            FROM (
                SELECT device_id,
                    MAX(inserted_date_at_utc) AS max_inserted_date
                FROM device_pings
                GROUP BY device_id
            ) AS latest_pings
            WHERE dp.device_id = latest_pings.device_id
            AND dp.inserted_date_at_utc = latest_pings.max_inserted_date
        </sql>
    </changeSet>
</databaseChangeLog>